<div class="dashboard-container">
  <!-- Toolbar -->
  <mat-toolbar class="dashboard-toolbar">
    <div class="toolbar-content">
      <div class="toolbar-left">
        <button mat-button [matMenuTriggerFor]="menu" class="app-title-button">
          <h1 class="app-title">Andina Trading</h1>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="navigateToStocks()">
            <mat-icon>show_chart</mat-icon>
            <span>Ver Acciones</span>
          </button>
          <button mat-menu-item (click)="logout()">
            <mat-icon>logout</mat-icon>
            <span>Cerrar Sesi贸n</span>
          </button>
        </mat-menu>
      </div>
      <div class="toolbar-right">
        <div class="user-info" *ngIf="currentUser">
          <span class="user-name">{{ currentUser.nombre }}</span>
          <span class="user-type">{{ currentUser.tipo }}</span>
        </div>
      </div>
    </div>
  </mat-toolbar>

  <!-- Main Content -->
  <div class="dashboard-content">
    <!-- Vista para Admin -->
    <div *ngIf="isAdmin" class="admin-view">
      <!-- Tabs para navegar entre Usuarios y Tira Auditora -->
      <mat-tab-group [(selectedIndex)]="selectedAuditTab" (selectedIndexChange)="onAuditTabChange($event)" class="admin-tabs">
        <!-- Tab de Usuarios -->
        <mat-tab label="Usuarios">
          <mat-card class="users-card">
        <mat-card-header>
          <mat-card-title>
            Gesti贸n de Usuarios
          </mat-card-title>
          <mat-card-subtitle>Administra todos los usuarios registrados en la aplicaci贸n</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="users-header">
            <button 
              mat-raised-button 
              color="primary" 
              (click)="openUserDialog()"
              class="add-user-button">
              Nuevo Usuario
            </button>
          </div>
          
          <div *ngIf="users.length === 0" class="no-users">
            <p>No hay usuarios registrados</p>
          </div>
          
          <table mat-table [dataSource]="users" class="users-table" *ngIf="users.length > 0">
            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let user">{{ user.id }}</td>
            </ng-container>

            <!-- Nombre Column -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>Nombre</th>
              <td mat-cell *matCellDef="let user">{{ user.nombre }}</td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">{{ user.email }}</td>
            </ng-container>

            <!-- Tel茅fono Column -->
            <ng-container matColumnDef="telefono">
              <th mat-header-cell *matHeaderCellDef>Tel茅fono</th>
              <td mat-cell *matCellDef="let user">{{ user.telefono }}</td>
            </ng-container>

            <!-- Tipo Column -->
            <ng-container matColumnDef="tipo">
              <th mat-header-cell *matHeaderCellDef>Tipo</th>
              <td mat-cell *matCellDef="let user">
                <mat-chip [ngClass]="'tipo-' + user.tipo">
                  {{ user.tipo === 'inversionista' ? 'Inversionista' : user.tipo === 'comisionista' ? 'Comisionista' : 'Admin' }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Fecha Registro Column -->
            <ng-container matColumnDef="fecha_registro">
              <th mat-header-cell *matHeaderCellDef>Fecha Registro</th>
              <td mat-cell *matCellDef="let user">
                {{ user.fecha_registro | date:'short':'es-ES' }}
              </td>
            </ng-container>

            <!-- Acciones Column -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let user">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="openUserDialog(user)"
                  class="edit-button"
                  matTooltip="Editar usuario">
                  Editar
                </button>
                <button 
                  mat-raised-button 
                  color="warn" 
                  (click)="deleteUser(user)"
                  class="delete-button"
                  matTooltip="Eliminar usuario">
                  Eliminar
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedUserColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedUserColumns;"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- Dialog para crear/editar usuario -->
      <div *ngIf="userForm" class="user-dialog-overlay" (click)="closeUserDialog()">
        <div class="user-dialog-content" (click)="$event.stopPropagation()">
          <mat-card class="user-dialog-card">
            <mat-card-header>
              <mat-card-title>
                {{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="userForm" class="user-form">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="nombre" placeholder="Nombre completo" />
                  @if (userForm.get('nombre')?.invalid && userForm.get('nombre')?.touched) {
                    <mat-error>El nombre es requerido</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Email</mat-label>
                  <input matInput type="email" formControlName="email" placeholder="email@ejemplo.com" />
                  @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
                    <mat-error>
                      @if (userForm.get('email')?.errors?.['required']) {
                        El email es requerido
                      } @else if (userForm.get('email')?.errors?.['email']) {
                        Ingresa un email v谩lido
                      }
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Tel茅fono</mat-label>
                  <input matInput formControlName="telefono" placeholder="Tel茅fono" />
                  @if (userForm.get('telefono')?.invalid && userForm.get('telefono')?.touched) {
                    <mat-error>El tel茅fono es requerido</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Direcci贸n</mat-label>
                  <input matInput formControlName="direccion" placeholder="Direcci贸n" />
                  @if (userForm.get('direccion')?.invalid && userForm.get('direccion')?.touched) {
                    <mat-error>La direcci贸n es requerida</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Tipo de Usuario</mat-label>
                  <mat-select formControlName="tipo">
                    <mat-option value="inversionista">Inversionista</mat-option>
                    <mat-option value="comisionista">Comisionista</mat-option>
                  </mat-select>
                  @if (userForm.get('tipo')?.invalid && userForm.get('tipo')?.touched) {
                    <mat-error>El tipo es requerido</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Contrase帽a</mat-label>
                  <input matInput type="password" formControlName="password" placeholder="M铆nimo 6 caracteres" />
                  @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
                    <mat-error>
                      @if (userForm.get('password')?.errors?.['required']) {
                        La contrase帽a es requerida
                      } @else if (userForm.get('password')?.errors?.['minlength']) {
                        La contrase帽a debe tener al menos 6 caracteres
                      }
                    </mat-error>
                  }
                </mat-form-field>

                <div class="dialog-actions">
                  <button 
                    mat-raised-button 
                    color="primary" 
                    (click)="saveUser()"
                    [disabled]="userForm.invalid">
                    {{ editingUser ? 'Actualizar' : 'Crear' }}
                  </button>
                  <button 
                    mat-button 
                    (click)="closeUserDialog()">
                    Cancelar
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
        </mat-tab>

        <!-- Tab de Gesti贸n de Acciones -->
        <mat-tab label="Gesti贸n de Acciones">
          <mat-card class="stocks-management-card">
            <mat-card-header>
              <mat-card-title>
                Gesti贸n de Acciones
              </mat-card-title>
              <mat-card-subtitle>Administra todas las acciones disponibles en la aplicaci贸n</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="stocks-header">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="openStockDialog()"
                  class="add-stock-button">
                  Nueva Acci贸n
                </button>
              </div>
              
              <div *ngIf="stocksList.length === 0" class="no-stocks">
                <p>No hay acciones registradas</p>
              </div>
              
              <table mat-table [dataSource]="stocksList" class="stocks-table" *ngIf="stocksList.length > 0">
                <!-- Symbol Column -->
                <ng-container matColumnDef="symbol">
                  <th mat-header-cell *matHeaderCellDef>S铆mbolo</th>
                  <td mat-cell *matCellDef="let stock">{{ stock.symbol }}</td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Nombre</th>
                  <td mat-cell *matCellDef="let stock">{{ stock.name }}</td>
                </ng-container>

                <!-- Country Column -->
                <ng-container matColumnDef="country">
                  <th mat-header-cell *matHeaderCellDef>Pa铆s</th>
                  <td mat-cell *matCellDef="let stock">
                    <mat-chip [ngClass]="'country-' + stock.country.toLowerCase()">
                      {{ stock.country }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef>Precio</th>
                  <td mat-cell *matCellDef="let stock">
                    ${{ stock.price.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
                  </td>
                </ng-container>

                <!-- Change Column -->
                <ng-container matColumnDef="change">
                  <th mat-header-cell *matHeaderCellDef>Cambio</th>
                  <td mat-cell *matCellDef="let stock">
                    <span [ngClass]="stock.change >= 0 ? 'positive' : 'negative'">
                      {{ stock.change >= 0 ? '+' : '' }}${{ stock.change.toFixed(2) }}
                    </span>
                  </td>
                </ng-container>

                <!-- Change Percent Column -->
                <ng-container matColumnDef="changePercent">
                  <th mat-header-cell *matHeaderCellDef>% Cambio</th>
                  <td mat-cell *matCellDef="let stock">
                    <mat-chip [ngClass]="stock.changePercent >= 0 ? 'positive' : 'negative'">
                      {{ stock.changePercent >= 0 ? '+' : '' }}{{ stock.changePercent.toFixed(2) }}%
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Volume Column -->
                <ng-container matColumnDef="volume">
                  <th mat-header-cell *matHeaderCellDef>Volumen</th>
                  <td mat-cell *matCellDef="let stock">{{ stock.volume.toLocaleString('es-ES') }}</td>
                </ng-container>

                <!-- Acciones Column -->
                <ng-container matColumnDef="acciones">
                  <th mat-header-cell *matHeaderCellDef>Acciones</th>
                  <td mat-cell *matCellDef="let stock">
                    <button 
                      mat-raised-button 
                      color="primary" 
                      (click)="openStockDialog(stock)"
                      class="edit-button"
                      matTooltip="Editar acci贸n">
                      Editar
                    </button>
                    <button 
                      mat-raised-button 
                      color="warn" 
                      (click)="deleteStock(stock)"
                      class="delete-button"
                      matTooltip="Eliminar acci贸n">
                      Eliminar
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedStockColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedStockColumns;"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- Dialog para crear/editar acci贸n -->
          <div *ngIf="stockForm" class="stock-dialog-overlay" (click)="closeStockDialog()">
            <div class="stock-dialog-content" (click)="$event.stopPropagation()">
              <mat-card class="stock-dialog-card">
                <mat-card-header>
                  <mat-card-title>
                    {{ editingStock ? 'Editar Acci贸n' : 'Nueva Acci贸n' }}
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="stockForm" class="stock-form">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>S铆mbolo</mat-label>
                      <input matInput formControlName="symbol" placeholder="ECOPETROL" [readonly]="editingStock !== null" />
                      @if (stockForm.get('symbol')?.invalid && stockForm.get('symbol')?.touched) {
                        <mat-error>
                          @if (stockForm.get('symbol')?.errors?.['required']) {
                            El s铆mbolo es requerido
                          } @else if (stockForm.get('symbol')?.errors?.['pattern']) {
                            Solo letras may煤sculas, n煤meros y guiones bajos
                          }
                        </mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Nombre</mat-label>
                      <input matInput formControlName="name" placeholder="Nombre de la empresa" />
                      @if (stockForm.get('name')?.invalid && stockForm.get('name')?.touched) {
                        <mat-error>El nombre es requerido</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Pa铆s *</mat-label>
                      <mat-select formControlName="country" placeholder="Seleccione un pa铆s">
                        <mat-option value="Colombia"> Colombia</mat-option>
                        <mat-option value="Ecuador"> Ecuador</mat-option>
                        <mat-option value="Per煤">叼 Per煤</mat-option>
                      </mat-select>
                      @if (stockForm.get('country')?.invalid && stockForm.get('country')?.touched) {
                        <mat-error>El pa铆s es requerido</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Precio</mat-label>
                      <input matInput type="number" formControlName="price" placeholder="0.00" min="0.01" step="0.01" />
                      <span matPrefix>$</span>
                      @if (stockForm.get('price')?.invalid && stockForm.get('price')?.touched) {
                        <mat-error>
                          @if (stockForm.get('price')?.errors?.['required']) {
                            El precio es requerido
                          } @else if (stockForm.get('price')?.errors?.['min']) {
                            El precio debe ser mayor a 0
                          }
                        </mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Cambio</mat-label>
                      <input matInput type="number" formControlName="change" placeholder="0.00" step="0.01" />
                      <span matPrefix>$</span>
                      @if (stockForm.get('change')?.invalid && stockForm.get('change')?.touched) {
                        <mat-error>El cambio es requerido</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>% Cambio</mat-label>
                      <input matInput type="number" formControlName="changePercent" placeholder="0.00" step="0.01" />
                      <span matSuffix>%</span>
                      @if (stockForm.get('changePercent')?.invalid && stockForm.get('changePercent')?.touched) {
                        <mat-error>El porcentaje de cambio es requerido</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Volumen</mat-label>
                      <input matInput type="number" formControlName="volume" placeholder="0" min="0" />
                      @if (stockForm.get('volume')?.invalid && stockForm.get('volume')?.touched) {
                        <mat-error>
                          @if (stockForm.get('volume')?.errors?.['required']) {
                            El volumen es requerido
                          } @else if (stockForm.get('volume')?.errors?.['min']) {
                            El volumen debe ser mayor o igual a 0
                          }
                        </mat-error>
                      }
                    </mat-form-field>

                    <div class="dialog-actions">
                      <button 
                        mat-raised-button 
                        color="primary" 
                        (click)="saveStock()"
                        [disabled]="stockForm.invalid">
                        {{ editingStock ? 'Actualizar' : 'Crear' }}
                      </button>
                      <button 
                        mat-button 
                        (click)="closeStockDialog()">
                        Cancelar
                      </button>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </mat-tab>

        <!-- Tab de Tira Auditora -->
        <mat-tab label="Tira Auditora">
          <mat-card class="audit-card">
            <mat-card-header>
              <mat-card-title>
                Tira Auditora
              </mat-card-title>
              <mat-card-subtitle>Registro de todas las acciones realizadas en la aplicaci贸n</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="auditLogs.length === 0" class="no-logs">
                <p>No hay registros de auditor铆a disponibles</p>
              </div>
              
              <table mat-table [dataSource]="auditLogs" class="audit-table" *ngIf="auditLogs.length > 0">
                <!-- Fecha Column -->
                <ng-container matColumnDef="fecha">
                  <th mat-header-cell *matHeaderCellDef>Fecha y Hora</th>
                  <td mat-cell *matCellDef="let log">{{ log.fecha }}</td>
                </ng-container>

                <!-- Usuario Column -->
                <ng-container matColumnDef="usuario">
                  <th mat-header-cell *matHeaderCellDef>Usuario</th>
                  <td mat-cell *matCellDef="let log">{{ log.usuario }}</td>
                </ng-container>

                <!-- Acci贸n Column -->
                <ng-container matColumnDef="accion">
                  <th mat-header-cell *matHeaderCellDef>Acci贸n</th>
                  <td mat-cell *matCellDef="let log">
                    <span class="action-badge" [ngClass]="'action-' + log.accion.toLowerCase().replace('_', '-')">
                      {{ log.accion }}
                    </span>
                  </td>
                </ng-container>

                <!-- Detalles Column -->
                <ng-container matColumnDef="detalles">
                  <th mat-header-cell *matHeaderCellDef>Detalles</th>
                  <td mat-cell *matCellDef="let log">{{ log.detalles }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedAuditColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedAuditColumns;"></tr>
              </table>
            </mat-card-content>
          </mat-card>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- Vista para Comisionista -->
    <div *ngIf="isComisionista" class="comisionista-view">
      <!-- Tabs para navegar entre Contratos, Recomendaciones y Gesti贸n de Acciones -->
      <mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)" class="comisionista-tabs">
        <!-- Tab de Contratos -->
        <mat-tab label="Contratos">
          <!-- Contratos Pendientes -->
          <mat-card class="contracts-card">
        <mat-card-header>
          <mat-card-title>
            Contratos Pendientes de Firma
          </mat-card-title>
          <mat-card-subtitle>Lista de contratos creados por inversionistas</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="contracts.length === 0" class="no-contracts">
            <mat-icon class="empty-icon">inbox</mat-icon>
            <p>No hay contratos disponibles</p>
          </div>
          <table mat-table [dataSource]="contracts" class="contracts-table" *ngIf="contracts.length > 0">
            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let contrato">{{ contrato.id_contrato }}</td>
            </ng-container>

            <!-- Fecha Column -->
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef>Fecha</th>
              <td mat-cell *matCellDef="let contrato">
                {{ contrato.fecha_creacion | date:'short':'es-ES' }}
              </td>
            </ng-container>

            <!-- Inversionista Column -->
            <ng-container matColumnDef="inversionista">
              <th mat-header-cell *matHeaderCellDef>Inversionista</th>
              <td mat-cell *matCellDef="let contrato">
                {{ getContractDetails(contrato.id_contrato).investorName || 'N/A' }}
              </td>
            </ng-container>

            <!-- Acci贸n Column -->
            <ng-container matColumnDef="accion">
              <th mat-header-cell *matHeaderCellDef>Acci贸n</th>
              <td mat-cell *matCellDef="let contrato">
                <div class="stock-info-cell">
                  <span class="stock-symbol">{{ getContractDetails(contrato.id_contrato).symbol || 'N/A' }}</span>
                  <span class="stock-name">{{ getContractDetails(contrato.id_contrato).stockName || '' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Cantidad Column -->
            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let contrato">
                {{ getContractDetails(contrato.id_contrato).cantidad || 0 }} acciones
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Valor Total</th>
              <td mat-cell *matCellDef="let contrato">
                ${{ getContractDetails(contrato.id_contrato).total?.toFixed(2) || '0.00' }}
              </td>
            </ng-container>

            <!-- Acciones Column -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let contrato">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="signAndDownloadContract(contrato)"
                  class="sign-button">
                  Firmar y Descargar
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </mat-card-content>
      </mat-card>
        </mat-tab>

        <!-- Tab de Recomendaciones -->
        <mat-tab label="Recomendaciones">
          <!-- Vista de Trading para Comisionista -->
          <div class="trading-section">
            <h2 class="section-title">An谩lisis y Recomendaciones</h2>
            
            <!-- Layout Principal: Gr谩fico, Panel de Compra, Panel de Selecci贸n -->
            <div class="charts-grid-first-row">
          <!-- Columna Izquierda: Gr谩fico -->
          <mat-card class="chart-card">
            <mat-card-content>
              <canvas #lineChartCanvas class="chart"></canvas>
            </mat-card-content>
          </mat-card>

          <!-- Columna Central: Panel de Compra -->
          <mat-card class="chart-card purchase-panel">
            <mat-card-content>
              <h2 class="panel-title">Crear Recomendaci贸n</h2>
              
              <div class="purchase-info" *ngIf="selectedStock; else noStockSelected">
                <div class="selected-stock-info">
                  <div class="stock-header-compra">
                    <span class="stock-symbol-compra">{{ selectedStock.symbol }}</span>
                    <mat-chip 
                      [ngClass]="selectedStock.changePercent >= 0 ? 'positive' : 'negative'"
                      class="change-chip-small">
                      <mat-icon>{{ selectedStock.changePercent >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
                      {{ selectedStock.changePercent >= 0 ? '+' : '' }}{{ selectedStock.changePercent.toFixed(2) }}%
                    </mat-chip>
                  </div>
                  <div class="stock-name-compra">{{ selectedStock.name }}</div>
                  <div class="stock-price-display">
                    <span class="price-label">Precio actual:</span>
                    <span class="price-value">${{ selectedStock.price.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                  </div>
                </div>

                <mat-form-field appearance="outline" class="quantity-field">
                  <mat-label>Cantidad</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [(ngModel)]="cantidadCompra"
                    (ngModelChange)="onCantidadChange()"
                    min="1"
                    required>
                  <mat-icon matPrefix>shopping_cart</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="price-field">
                  <mat-label>Precio por unidad</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [(ngModel)]="precioCompra"
                    (ngModelChange)="calculateTotal()"
                    min="0"
                    step="0.01"
                    required>
                  <span matPrefix>$</span>
                </mat-form-field>

                <div class="total-section">
                  <div class="total-label">Total a recomendar:</div>
                  <div class="total-value">${{ totalCompra.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</div>
                </div>

                <button 
                  mat-raised-button 
                  color="primary"
                  class="buy-button"
                  (click)="comprarAccion()"
                  [disabled]="cantidadCompra <= 0 || precioCompra <= 0">
                  Crear Recomendaci贸n
                </button>
              </div>

              <ng-template #noStockSelected>
                <div class="empty-purchase-state">
                  <mat-icon class="empty-icon">shopping_cart</mat-icon>
                  <p>Selecciona una acci贸n para crear recomendaci贸n</p>
                </div>
              </ng-template>
            </mat-card-content>
          </mat-card>

          <!-- Columna Derecha: Panel de Selecci贸n de Acciones -->
          <mat-card class="chart-card stocks-panel">
            <mat-card-content>
              <h2 class="panel-title">Seleccionar Acci贸n</h2>
              
              <mat-form-field appearance="outline" class="country-filter">
                <mat-label>Filtrar por Pa铆s</mat-label>
                <mat-select [(ngModel)]="selectedCountry" (selectionChange)="onCountryChange()">
                  <mat-option value="all">Todos los Pa铆ses</mat-option>
                  <mat-option value="Colombia">Colombia (BVC)</mat-option>
                  <mat-option value="Ecuador">Ecuador</mat-option>
                  <mat-option value="Per煤">Per煤 (BVL)</mat-option>
                </mat-select>
              </mat-form-field>

              <div class="stocks-list-container">
                <mat-list class="stocks-list">
                  <mat-list-item 
                    *ngFor="let stock of filteredStocks" 
                    class="stock-item"
                    [class.selected]="selectedStock?.symbol === stock.symbol"
                    (click)="selectStock(stock)">
                    <div class="stock-info">
                      <div class="stock-header">
                        <div class="stock-symbol">{{ stock.symbol }}</div>
                        <mat-chip 
                          [ngClass]="stock.changePercent >= 0 ? 'positive' : 'negative'"
                          class="change-chip">
                          <mat-icon>{{ stock.changePercent >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
                          {{ stock.changePercent >= 0 ? '+' : '' }}{{ stock.changePercent.toFixed(2) }}%
                        </mat-chip>
                      </div>
                      <div class="stock-name">{{ stock.name }}</div>
                      <div class="stock-details">
                        <span class="country-badge" [ngClass]="'country-' + stock.country.toLowerCase()">
                          {{ stock.country }}
                        </span>
                        <span class="stock-price">${{ stock.price.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                      </div>
                    </div>
                  </mat-list-item>
                </mat-list>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Lista de Recomendaciones Creadas -->
      <mat-card class="my-recommendations-card" *ngIf="recomendacionesCreadas.length > 0">
        <mat-card-header>
          <mat-card-title>

            Mis Recomendaciones Creadas
          </mat-card-title>
          <mat-card-subtitle>Historial de recomendaciones que has creado</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="my-recommendations-list">
            <div 
              *ngFor="let rec of recomendacionesCreadas" 
              class="my-recommendation-item">
              <div class="recommendation-header">
                <div class="recommendation-stock">
                  <span class="recommendation-symbol">{{ rec.id_accion }}</span>
                  <span class="recommendation-name">{{ rec.nombre_accion }}</span>
                </div>
                <div class="recommendation-actions">
                  <button 
                    mat-raised-button
                    class="delete-button"
                    (click)="eliminarRecomendacion(rec.id_recomendacion)"
                    matTooltip="Eliminar recomendaci贸n">
                   
                    Eliminar
                  </button>
                </div>
              </div>
              <div class="recommendation-details">
                <div class="recommendation-info">
                  <span><strong>Cantidad:</strong> {{ rec.cantidad }} acciones</span>
                  <span><strong>Precio:</strong> ${{ rec.precio.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                  <span><strong>Total:</strong> ${{ rec.valor_total.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                </div>
                <div class="recommendation-meta">
                  <span class="recommendation-date">{{ rec.fecha_recomendacion | date:'short':'es-ES' }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="my-recommendations-card" *ngIf="recomendacionesCreadas.length === 0">
        <mat-card-content>
          <div class="no-recommendations">
            <mat-icon class="empty-icon">star_border</mat-icon>
            <p>No has creado recomendaciones a煤n</p>
            <p class="hint">Usa la secci贸n de arriba para crear tu primera recomendaci贸n</p>
          </div>
        </mat-card-content>
      </mat-card>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- Vista para Inversionista (vista original) -->
    <div *ngIf="isInversionista">
      <!-- Recomendaciones del Comisionista -->
      <mat-card class="recommendations-card" *ngIf="recomendaciones.length > 0">
        <mat-card-header>
          <mat-card-title>
            Recomendaciones del Comisionista
          </mat-card-title>
          <mat-card-subtitle>ltimas recomendaciones de inversi贸n</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="recommendations-list">
            <div 
              *ngFor="let rec of recomendaciones" 
              class="recommendation-item"
              (click)="aplicarRecomendacion(rec)">
              <div class="recommendation-header">
                <div class="recommendation-stock">
                  <span class="recommendation-symbol">{{ rec.id_accion }}</span>
                  <span class="recommendation-name">{{ rec.nombre_accion }}</span>
                </div>
                <mat-chip class="recommendation-badge">
                  Recomendado
                </mat-chip>
              </div>
              <div class="recommendation-details">
                <div class="recommendation-info">
                  <span><strong>Cantidad:</strong> {{ rec.cantidad }} acciones</span>
                  <span><strong>Precio:</strong> ${{ rec.precio.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                  <span><strong>Total:</strong> ${{ rec.valor_total.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                </div>
                <div class="recommendation-meta">
                  <span class="recommendation-comisionista">Por: {{ rec.nombre_comisionista }}</span>
                  <span class="recommendation-date">{{ rec.fecha_recomendacion | date:'short':'es-ES' }}</span>
                </div>
              </div>
              <button 
                mat-raised-button 
                color="primary" 
                class="apply-recommendation-btn"
                (click)="aplicarRecomendacion(rec); $event.stopPropagation()">
              
                Aplicar Recomendaci贸n
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Estad铆sticas R谩pidas -->
      <div class="stats-grid">
        <mat-card class="stat-card" *ngFor="let stat of stats">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-label">{{ stat.label }}</div>
              <div class="stat-value">{{ stat.value }}</div>
              <div class="stat-change" [class.positive]="stat.positive" [class.negative]="!stat.positive">
                <mat-icon>{{ stat.positive ? 'trending_up' : 'trending_down' }}</mat-icon>
                {{ stat.change }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

    <!-- Layout Principal -->
    <!-- Tres columnas: Espacio Izquierdo, Panel de Compra (centro), Panel de Selecci贸n (derecha) -->
    <div class="charts-grid-first-row">
      <!-- Columna Izquierda: Gr谩fico -->
      <mat-card class="chart-card">
        <mat-card-content>
          <canvas #lineChartCanvas class="chart"></canvas>
        </mat-card-content>
      </mat-card>

      <!-- Columna Central: Panel de Compra -->
      <mat-card class="chart-card purchase-panel">
        <mat-card-content>
          <h2 class="panel-title">Comprar Acci贸n</h2>
          
          <div class="purchase-info" *ngIf="selectedStock; else noStockSelected">
            <div class="selected-stock-info">
              <div class="stock-header-compra">
                <span class="stock-symbol-compra">{{ selectedStock.symbol }}</span>
                <mat-chip 
                  [ngClass]="selectedStock.changePercent >= 0 ? 'positive' : 'negative'"
                  class="change-chip-small">
                  <mat-icon>{{ selectedStock.changePercent >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
                  {{ selectedStock.changePercent >= 0 ? '+' : '' }}{{ selectedStock.changePercent.toFixed(2) }}%
                </mat-chip>
              </div>
              <div class="stock-name-compra">{{ selectedStock.name }}</div>
              <div class="stock-price-display">
                <span class="price-label">Precio actual:</span>
                <span class="price-value">${{ selectedStock.price.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
              </div>
            </div>

            <mat-form-field appearance="outline" class="quantity-field">
              <mat-label>Cantidad</mat-label>
              <input 
                matInput 
                type="number" 
                [(ngModel)]="cantidadCompra"
                (ngModelChange)="onCantidadChange()"
                min="1"
                required>
              <mat-icon matPrefix>shopping_cart</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="price-field">
              <mat-label>Precio por unidad</mat-label>
              <input 
                matInput 
                type="number" 
                [(ngModel)]="precioCompra"
                (ngModelChange)="calculateTotal()"
                min="0"
                step="0.01"
                required>
              <span matPrefix>$</span>
            </mat-form-field>

            <div class="total-section">
              <div class="total-label">Total a pagar:</div>
              <div class="total-value">${{ totalCompra.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</div>
            </div>

            <button 
              mat-raised-button 
              color="primary" 
              class="buy-button"
              (click)="comprarAccion()"
              [disabled]="cantidadCompra <= 0 || precioCompra <= 0">
              
              Comprar Acci贸n
            </button>
          </div>

          <ng-template #noStockSelected>
            <div class="empty-purchase-state">
              <mat-icon class="empty-icon">shopping_cart</mat-icon>
              <p>Selecciona una acci贸n para comprar</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- Columna Derecha: Panel de Selecci贸n de Acciones -->
      <mat-card class="chart-card stocks-panel">
        <mat-card-content>
          <h2 class="panel-title">Seleccionar Acci贸n</h2>
          
          <mat-form-field appearance="outline" class="country-filter">
            <mat-label>Filtrar por Pa铆s</mat-label>
            <mat-select [(ngModel)]="selectedCountry" (selectionChange)="onCountryChange()">
              <mat-option value="all">Todos los Pa铆ses</mat-option>
              <mat-option value="Colombia">Colombia (BVC)</mat-option>
              <mat-option value="Ecuador">Ecuador</mat-option>
              <mat-option value="Per煤">Per煤 (BVL)</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="stocks-list-container">
            <mat-list class="stocks-list">
              <mat-list-item 
                *ngFor="let stock of filteredStocks" 
                class="stock-item"
                [class.selected]="selectedStock?.symbol === stock.symbol"
                (click)="selectStock(stock)">
                <div class="stock-info">
                  <div class="stock-header">
                    <div class="stock-symbol">{{ stock.symbol }}</div>
                    <mat-chip 
                      [ngClass]="stock.changePercent >= 0 ? 'positive' : 'negative'"
                      class="change-chip">
                      <mat-icon>{{ stock.changePercent >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
                      {{ stock.changePercent >= 0 ? '+' : '' }}{{ stock.changePercent.toFixed(2) }}%
                    </mat-chip>
                  </div>
                  <div class="stock-name">{{ stock.name }}</div>
                  <div class="stock-details">
                    <span class="country-badge" [ngClass]="'country-' + stock.country.toLowerCase()">
                      {{ stock.country }}
                    </span>
                    <span class="stock-price">${{ stock.price.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
                  </div>
                </div>
              </mat-list-item>
            </mat-list>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Panel de Compras Realizadas -->
    <mat-card class="purchases-card">
      <mat-card-header>
        <mat-card-title>
      
          Historial de Compras
        </mat-card-title>
        <mat-card-subtitle>Lista de todas las compras realizadas</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="purchases.length === 0" class="no-purchases">
          <mat-icon class="empty-icon">shopping_cart</mat-icon>
          <p>No has realizado compras a煤n</p>
          <p class="hint">Cuando realices tu primera compra, aparecer谩 aqu铆</p>
        </div>
        <div *ngIf="purchases.length > 0" class="purchases-list">
          <div 
            *ngFor="let purchase of purchases" 
            class="purchase-item">
            <div class="purchase-header">
              <div class="purchase-stock">
                <span class="purchase-symbol">{{ purchase.id_accion }}</span>
                <span class="purchase-name">{{ getStockName(purchase.id_accion) }}</span>
              </div>
              <div class="purchase-status">
                <mat-chip class="status-chip completed">
              
                  Completada
                </mat-chip>
              </div>
            </div>
            <div class="purchase-details">
              <div class="purchase-info">
                <span class="info-item">
                 
                  <strong>Cantidad:</strong> {{ purchase.cantidad }} acciones
                </span>
                <span class="info-item">
           
                  <strong>Precio unitario:</strong> ${{ purchase.precio.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
                </span>
                <span class="info-item">
              
                  <strong>Total:</strong> ${{ (purchase.cantidad * purchase.precio).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}
                </span>
              </div>
              <div class="purchase-meta">
                <span class="purchase-country" *ngIf="getStockCountry(purchase.id_accion)">
              
                  {{ getStockCountry(purchase.id_accion) }}
                </span>
                <span class="purchase-date">
                  
                  {{ purchase.fecha_orden | date:'short':'es-ES' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    </div>

  </div>
</div>

